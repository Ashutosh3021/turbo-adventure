<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e90ff">
    <meta name="description" content="Multi-Personality Chat - AI Assistant Suite">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <title>Multi-Personality Chat - AI Assistant Suite</title>
    <style>
        :root {
            --primary: #1e90ff;
            --secondary: #ff6b35;
            --dark: #000000;
            --darker: #000000;
            --surface: #16213e;
            --text: #eaeaea;
            --text-secondary: #b0b0b0;
            --success: #00d4ff;
            --danger: #ff4757;
            --warning: #ffa502;
            --border-radius: 4px;
        }

        [data-theme="light"] {
            --dark: #f5f5f5;
            --darker: #e8e8e8;
            --surface: #ffffff;
            --text: #1a1a1a;
            --text-secondary: #666666;
        }

        /* Dark theme specific overrides for header and input-area */
        [data-theme="dark"] .header,
        [data-theme="dark"] .input-area {
            background: #000000;
            color: #ffffff;
        }

        [data-theme="dark"] .header * {
            color: #ffffff;
        }

        [data-theme="dark"] .input-area * {
            color: #ffffff;
        }

        [data-theme="dark"] .message-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        [data-theme="dark"] .message-input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .current-character {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Dark theme specific overrides for sidebar and messages container */
        [data-theme="dark"] .sidebar,
        [data-theme="dark"] .chat-container {
            background: #000000;
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .messages {
            background: #000000;
        }

        [data-theme="dark"] .sidebar-title {
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .character-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        [data-theme="dark"] .character-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
        }

        [data-theme="dark"] .character-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        [data-theme="dark"] .character-item.active * {
            color: white;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--dark);
            color: var(--text);
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(30, 144, 255, 0.1);
            transition: background 0.3s ease;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .current-character {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .current-character strong {
            color: var(--success);
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Theme Toggle Switch */
        .theme-toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(30, 144, 255, 0.2);
            transition: 0.3s;
            border-radius: 26px;
            border: 1px solid var(--primary);
        }

        .toggle-slider:before {
            position: absolute;
            content: "ðŸŒ™";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--primary);
            transition: 0.3s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        input:checked + .toggle-slider {
            background-color: rgba(30, 144, 255, 0.3);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
            content: "â˜€";
        }

        .icon-btn {
            background: rgba(30, 144, 255, 0.2);
            border: 1px solid var(--primary);
            color: var(--primary);
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: var(--primary);
            color: var(--dark);
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            gap: 16px;
            padding: 16px;
            overflow: hidden;
        }

        /* Characters Sidebar */
        .sidebar {
            width: 220px;
            background: var(--surface);
            border-radius: var(--border-radius);
            border: 1px solid rgba(30, 144, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
            padding: 12px;
            transition: background 0.3s ease;
            position: relative;
            z-index: 100;
        }
        
        /* Collapsible sidebar for mobile */
        .sidebar.collapsed {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 16px;
                top: 80px;
                height: calc(100% - 120px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 1000;
            }
            
            .sidebar.collapsed {
                display: none;
            }
            
            .sidebar.expanded {
                display: flex;
            }
            
            #sidebarToggle {
                display: flex !important;
            }
            
            .main-content {
                flex-direction: row;
            }
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(30, 144, 255, 0.1);
        }

        .character-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .character-item {
            padding: 12px;
            background: rgba(30, 144, 255, 0.05);
            border: 1px solid rgba(30, 144, 255, 0.1);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            min-width: 180px;
        }

        .character-item:hover {
            background: rgba(30, 144, 255, 0.15);
            border-color: var(--primary);
        }

        .character-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .character-info-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .character-item:hover .character-info-btn {
            opacity: 0.7;
        }

        .character-info-btn:hover {
            opacity: 1 !important;
        }

        .character-color-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border-radius: var(--border-radius);
            border: 1px solid rgba(30, 144, 255, 0.1);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .message.user {
            justify-content: flex-end;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary), #0066cc);
            color: white;
        }

        .message.assistant .message-bubble {
            background: rgba(30, 144, 255, 0.1);
            color: var(--text);
            border: 1px solid rgba(30, 144, 255, 0.2);
        }

        /* Message Bubble Formatting */
        .message-bubble h1, .message-bubble h2, .message-bubble h3 {
            margin: 10px 0 8px 0;
            font-weight: 600;
            color: var(--text);
        }
        
        .message-bubble h1 {
            font-size: 1.4em;
            border-bottom: 1px solid rgba(30, 144, 255, 0.2);
            padding-bottom: 5px;
        }
        
        .message-bubble h2 {
            font-size: 1.25em;
        }
        
        .message-bubble h3 {
            font-size: 1.1em;
        }
        
        .message-bubble p {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .message-bubble ul, .message-bubble ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .message-bubble ul {
            list-style-type: disc;
        }
        
        .message-bubble ol {
            list-style-type: decimal;
        }
        
        .message-bubble li {
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .message-bubble strong {
            font-weight: 600;
            color: var(--text);
        }
        
        .message-bubble em {
            font-style: italic;
        }
        
        .message-bubble br + br {
            margin-bottom: 10px;
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            gap: 12px;
            text-align: center;
            padding: 20px;
        }

        .empty-chat-icon {
            font-size: 48px;
            opacity: 0.5;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Input Area */
        .input-area {
            padding: 16px;
            border-top: 1px solid rgba(30, 144, 255, 0.1);
            display: flex;
            gap: 12px;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            background: rgba(30, 144, 255, 0.05);
            border: 1px solid rgba(30, 144, 255, 0.2);
            color: var(--text);
            padding: 10px 14px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(30, 144, 255, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary), #0066cc);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid rgba(30, 144, 255, 0.3);
            border-radius: var(--border-radius);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transition: background 0.3s ease;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 24px;
            color: var(--success);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .form-input, .form-select {
            width: 100%;
            background: rgba(30, 144, 255, 0.05);
            border: 1px solid rgba(30, 144, 255, 0.2);
            color: var(--text);
            padding: 10px 12px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(30, 144, 255, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .color-picker-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .color-picker {
            width: 60px;
            height: 40px;
            border: 1px solid rgba(30, 144, 255, 0.2);
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(30, 144, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #0066cc);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(30, 144, 255, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(30, 144, 255, 0.2);
        }

        .btn-danger {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: rgba(255, 71, 87, 0.2);
        }

        .character-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(30, 144, 255, 0.1);
        }

        .tab-btn {
            padding: 10px 12px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: var(--success);
            border-bottom-color: var(--success);
        }

        .tab-btn:hover {
            color: var(--text);
        }

        /* Scrollbar Styling */
        .messages::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(30, 144, 255, 0.3);
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover,
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(30, 144, 255, 0.6);
        }

        .status-box {
            padding: 10px;
            border-radius: var(--border-radius);
            font-size: 13px;
            margin-top: 8px;
        }

        .status-box.success {
            background: rgba(0, 212, 255, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-box.error {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .manage-char-item {
            padding: 12px;
            background: rgba(30, 144, 255, 0.05);
            border: 1px solid rgba(30, 144, 255, 0.1);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manage-char-info {
            flex: 1;
        }

        .manage-char-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .manage-char-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .manage-char-actions {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 16px;
                top: 80px;
                height: calc(100% - 120px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 1000;
            }
            
            .sidebar.collapsed {
                display: none;
            }
            
            .sidebar.expanded {
                display: flex;
            }
            
            #sidebarToggle {
                display: flex !important;
            }
            
            .main-content {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <button class="icon-btn" id="sidebarToggle" title="Toggle Sidebar" style="display: none;">â˜°</button>
                <div class="current-character">
                    Currently: <strong id="currentCharName">JARVIS</strong>
                </div>
            </div>
            <div class="header-right">
                <label class="theme-toggle">
                    <input type="checkbox" id="themeToggle">
                    <span class="toggle-slider"></span>
                </label>
                <button class="icon-btn" id="settingsBtn" title="Settings">âš™</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-title">Characters</div>
                <div class="character-list" id="characterList"></div>
            </div>

            <div class="chat-container">
                <div class="messages" id="messages">
                    <div class="empty-chat">
                        <div class="empty-chat-icon">ðŸ’¬</div>
                        <div>Select or create a character to start</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Click âš™ to add new personalities</div>
                    </div>
                </div>
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea class="message-input" id="messageInput" placeholder="Type your message... (Shift+Enter for newline)" rows="1"></textarea>
                        <button class="send-btn" id="sendBtn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">âš™ Character Manager</div>

            <div class="character-tabs">
                <button class="tab-btn active" data-tab="api-settings">API Settings</button>
                <button class="tab-btn" data-tab="new-character">Add Character</button>
                <button class="tab-btn" data-tab="manage-characters">Manage</button>
            </div>

            <!-- API Settings Tab -->
            <div class="tab-content" data-tab="api-settings" style="display: block;">
                <div class="form-group">
                    <label class="form-label">OpenRouter API Key</label>
                    <input type="password" class="form-input" id="apiKeyInput" placeholder="Paste your OpenRouter API key...">
                    <small style="color: var(--text-secondary); margin-top: 8px; display: block;">
                        Get it from <a href="https://openrouter.ai" target="_blank" style="color: var(--primary);">openrouter.ai</a>
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Model Selection</label>
                    <select class="form-select" id="modelSelect">
                        <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B Instruct (Free)</option>
                        <option value="meta-llama/llama-2-70b-chat:free">Llama 2 70B Chat (Free)</option>
                        <option value="mistralai/mistral-7b-instruct:free">Mistral 7B Instruct (Free)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Temperature</label>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Focused</span>
                            <span id="tempValue">0.7</span>
                            <span>Creative</span>
                        </div>
                        <input type="range" class="slider" id="tempSlider" min="0" max="2" step="0.1" value="0.7">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Max Tokens</label>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Short</span>
                            <span id="tokensValue">1000</span>
                            <span>Long</span>
                        </div>
                        <input type="range" class="slider" id="tokensSlider" min="100" max="4000" step="100" value="1000">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div id="apiStatus" class="status-box error">
                        âœ— No API key set
                    </div>
                </div>
            </div>

            <!-- New Character Tab -->
            <div class="tab-content" data-tab="new-character" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Character Name</label>
                    <input type="text" class="form-input" id="charNameInput" placeholder="e.g., JARVIS, FRIDAY, Coder Bot...">
                </div>
                <div class="form-group">
                    <label class="form-label">Character Color</label>
                    <div class="color-picker-wrapper">
                        <input type="color" class="color-picker" id="charColorInput" value="#1e90ff">
                        <span style="color: var(--text-secondary); font-size: 13px;">Choose an accent color for this character</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">System Prompt</label>
                    <textarea class="form-input" id="charPromptInput" placeholder="Describe how this character should behave..."></textarea>
                    <small style="color: var(--text-secondary); margin-top: 8px; display: block;">
                        Example: "You are JARVIS, Tony Stark's AI assistant. You are formal, sophisticated, and speak in a British accent."
                    </small>
                </div>
            </div>

            <!-- Manage Characters Tab -->
            <div class="tab-content" data-tab="manage-characters" style="display: none;">
                <div id="manageCharsList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-primary" id="saveCharBtn">Save</button>
                <button class="btn-secondary" id="closeModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Character Info Modal -->
    <div class="modal" id="charInfoModal">
        <div class="modal-content">
            <div class="modal-title">ðŸ“‹ Character Information</div>
            
            <div class="form-group">
                <label class="form-label">Character Name</label>
                <input type="text" class="form-input" id="editCharName" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">Character Color</label>
                <div class="color-picker-wrapper">
                    <input type="color" class="color-picker" id="editCharColor">
                    <span style="color: var(--text-secondary); font-size: 13px;">Accent color</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">System Prompt</label>
                <textarea class="form-input" id="editCharPrompt"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Statistics</label>
                <div class="status-box success">
                    <div><strong>Messages:</strong> <span id="editCharMessages">0</span></div>
                    <div><strong>Created:</strong> <span id="editCharCreated">N/A</span></div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" id="clearHistoryBtn">Clear Chat History</button>
                <button class="btn-primary" id="saveEditCharBtn">Save Changes</button>
                <button class="btn-secondary" id="closeCharInfoBtn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE MANAGEMENT ============
        let state = {
            characters: [],
            currentCharacterId: null,
            apiKey: localStorage.getItem('openrouter_api_key') || '',
            theme: localStorage.getItem('theme') || 'dark',
            model: localStorage.getItem('model') || 'meta-llama/llama-3.3-70b-instruct:free',
            temperature: parseFloat(localStorage.getItem('temperature')) || 0.7,
            maxTokens: parseInt(localStorage.getItem('maxTokens')) || 1000,
            editingCharId: null
        };

        // ============ INITIALIZATION ============
        function init() {
            loadCharacters();
            loadApiKey();
            applyTheme();
            setupEventListeners();
            renderCharacterList();
            
            if (state.characters.length === 0) {
                createDefaultCharacters();
            } else if (state.currentCharacterId) {
                renderChat();
            }

            // Load model settings
            document.getElementById('modelSelect').value = state.model;
            document.getElementById('tempSlider').value = state.temperature;
            document.getElementById('tokensSlider').value = state.maxTokens;
            updateSliderValues();
            
            // Initialize mobile sidebar behavior
            initializeMobileSidebar();
        }

        function initializeMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 768) {
                // Mobile mode - hide sidebar by default
                sidebar.classList.add('collapsed');
                toggleButton.style.display = 'flex';
            } else {
                // Desktop mode - always show sidebar
                sidebar.classList.remove('collapsed');
                toggleButton.style.display = 'none';
            }
        }

        function createDefaultCharacters() {
            const defaults = [
                {
                    id: 'jarvis',
                    name: 'JARVIS',
                    systemPrompt: 'You are JARVIS, Tony Stark\'s AI assistant. You are formal, sophisticated, and speak with British eloquence. You are highly logical, protocol-focused, and always address the user as "Sir" or "Madam". You provide detailed, structured responses.',
                    color: '#1e90ff',
                    messages: [],
                    created: Date.now()
                },
                {
                    id: 'friday',
                    name: 'FRIDAY',
                    systemPrompt: 'You are FRIDAY, the successor to JARVIS. You are warm, empathetic, and modern in your communication style. You are approachable yet professional, and you use casual but intelligent language. You genuinely care about helping and being supportive.',
                    color: '#00d4ff',
                    messages: [],
                    created: Date.now()
                },
                {
                    id: 'coder',
                    name: 'Coder Bot',
                    systemPrompt: 'You are an expert software engineer and debugging specialist. You help with coding problems, explain code concepts, and provide practical solutions. You are direct, technical, and focused on solving problems efficiently. You use code examples when helpful.',
                    color: '#ff6b35',
                    messages: [],
                    created: Date.now()
                }
            ];

            state.characters = defaults;
            state.currentCharacterId = 'jarvis';
            saveCharacters();
            renderCharacterList();
            renderChat();
        }

        // ============ STORAGE ============
        function saveCharacters() {
            localStorage.setItem('characters', JSON.stringify(state.characters));
        }

        function loadCharacters() {
            const saved = localStorage.getItem('characters');
            if (saved) {
                state.characters = JSON.parse(saved);
                state.currentCharacterId = localStorage.getItem('currentCharacterId') || state.characters[0]?.id;
            }
        }

        function saveApiKey() {
            localStorage.setItem('openrouter_api_key', state.apiKey);
        }

        function loadApiKey() {
            state.apiKey = localStorage.getItem('openrouter_api_key') || '';
            updateApiStatus();
        }

        function saveSettings() {
            localStorage.setItem('model', state.model);
            localStorage.setItem('temperature', state.temperature);
            localStorage.setItem('maxTokens', state.maxTokens);
            localStorage.setItem('theme', state.theme);
        }

        // ============ THEME ============
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            saveSettings();
            applyTheme();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            const toggle = document.getElementById('themeToggle');
            toggle.checked = state.theme === 'light';
        }

        // ============ CHARACTER MANAGEMENT ============
        function getCurrentCharacter() {
            return state.characters.find(c => c.id === state.currentCharacterId);
        }

        function renderCharacterList() {
            const list = document.getElementById('characterList');
            list.innerHTML = state.characters.map(char => `
                <div class="character-item ${char.id === state.currentCharacterId ? 'active' : ''}" 
                     data-id="${char.id}"
                     style="padding-left: 20px; ${char.id === state.currentCharacterId ? `background: ${char.color}; border-color: ${char.color};` : ''}">
                    <span class="character-color-indicator" style="background: ${char.color};"></span>
                    <span>${char.name}</span>
                    <span class="character-info-btn" data-id="${char.id}" title="Character Info">â„¹</span>
                </div>
            `).join('');

            list.querySelectorAll('.character-item').forEach(item => {
                const id = item.dataset.id;
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('character-info-btn')) {
                        switchCharacter(id);
                    }
                });
            });

            list.querySelectorAll('.character-info-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showCharacterInfo(btn.dataset.id);
                });
            });
        }

        function switchCharacter(id) {
            state.currentCharacterId = id;
            localStorage.setItem('currentCharacterId', id);
            renderCharacterList();
            renderChat();
            updateCurrentCharName();
        }

        function updateCurrentCharName() {
            const char = getCurrentCharacter();
            document.getElementById('currentCharName').textContent = char?.name || 'None';
        }

        function addNewCharacter() {
            const name = document.getElementById('charNameInput').value.trim();
            const prompt = document.getElementById('charPromptInput').value.trim();
            const color = document.getElementById('charColorInput').value;

            if (!name || !prompt) {
                alert('Please fill in both name and system prompt');
                return;
            }

            const newChar = {
                id: Date.now().toString(),
                name: name,
                systemPrompt: prompt,
                color: color,
                messages: [],
                created: Date.now()
            };

            state.characters.push(newChar);
            saveCharacters();
            renderCharacterList();
            
            document.getElementById('charNameInput').value = '';
            document.getElementById('charPromptInput').value = '';
            document.getElementById('charColorInput').value = '#1e90ff';
            
            switchCharacter(newChar.id);
            alert(`âœ“ "${name}" created successfully!`);
        }

        function deleteCharacter(id) {
            if (state.characters.length === 1) {
                alert('Cannot delete the last character');
                return;
            }

            const char = state.characters.find(c => c.id === id);
            if (confirm(`Delete "${char.name}"? This cannot be undone.`)) {
                state.characters = state.characters.filter(c => c.id !== id);
                if (state.currentCharacterId === id) {
                    state.currentCharacterId = state.characters[0].id;
                }
                saveCharacters();
                renderCharacterList();
                renderChat();
                renderManageCharsList();
            }
        }

        // Function to clear chat history for a specific character
        function clearCharacterHistory(id) {
            const char = state.characters.find(c => c.id === id);
            if (!char) return;

            if (confirm(`Clear chat history for "${char.name}"? This cannot be undone.`)) {
                char.messages = [];
                saveCharacters();
                
                // If this is the current character, re-render the chat
                if (state.currentCharacterId === id) {
                    renderChat();
                }
                
                renderManageCharsList();
                alert(`âœ“ Chat history for "${char.name}" cleared successfully!`);
            }
        }

        function showCharacterInfo(id) {
            const char = state.characters.find(c => c.id === id);
            if (!char) return;

            state.editingCharId = id;
            document.getElementById('editCharName').value = char.name;
            document.getElementById('editCharColor').value = char.color;
            document.getElementById('editCharPrompt').value = char.systemPrompt;
            document.getElementById('editCharMessages').textContent = char.messages.length;
            document.getElementById('editCharCreated').textContent = new Date(char.created).toLocaleDateString();
            
            document.getElementById('charInfoModal').classList.add('active');
        }

        function saveCharacterEdit() {
            const char = state.characters.find(c => c.id === state.editingCharId);
            if (!char) return;

            char.color = document.getElementById('editCharColor').value;
            char.systemPrompt = document.getElementById('editCharPrompt').value.trim();

            if (!char.systemPrompt) {
                alert('System prompt cannot be empty');
                return;
            }

            saveCharacters();
            renderCharacterList();
            document.getElementById('charInfoModal').classList.remove('active');
            alert('âœ“ Character updated successfully!');
        }

        // Function to toggle sidebar visibility on mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            if (window.innerWidth <= 768) {
                // Toggle between expanded and collapsed states
                if (sidebar.classList.contains('expanded')) {
                    // Currently expanded, so collapse it
                    sidebar.classList.remove('expanded');
                    sidebar.classList.add('collapsed');
                } else {
                    // Currently collapsed, so expand it
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.add('expanded');
                }
            }
        }

        // Function to close sidebar when clicking outside
        function closeSidebarOnClickOutside(event) {
            const sidebar = document.querySelector('.sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('expanded') && 
                !sidebar.contains(event.target) && 
                event.target !== toggleButton) {
                sidebar.classList.remove('expanded');
                sidebar.classList.add('collapsed');
            }
        }

        // ============ CHAT MANAGEMENT ============
        function renderChat() {
            const char = getCurrentCharacter();
            if (!char) return;

            const messagesDiv = document.getElementById('messages');
            
            if (char.messages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="empty-chat">
                        <div class="empty-chat-icon">ðŸ’¬</div>
                        <div>Start a conversation with <strong>${char.name}</strong></div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Type a message below to begin</div>
                    </div>
                `;
            } else {
                messagesDiv.innerHTML = char.messages.map(msg => `
                    <div class="message ${msg.role}">
                        <div class="message-bubble" ${msg.role === 'assistant' ? `style="border-color: ${char.color};"` : ''}>${formatMessageContent(msg.content, msg.role)}</div>
                    </div>
                `).join('');
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // Function to format message content with proper HTML structure
        function formatMessageContent(content, role) {
            // For user messages, keep the original formatting
            if (role === 'user') {
                return escapeHtml(content).replace(/\n/g, '<br>');
            }
            
            // For assistant messages, apply advanced formatting
            return formatAssistantResponse(content);
        }

        // Function to format AI responses with better structure
        function formatAssistantResponse(content) {
            // First, escape HTML to prevent XSS
            let escapedContent = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
            
            // Process lists first
            let lines = escapedContent.split('\n');
            let inList = false;
            let listType = ''; // 'ul' or 'ol'
            let processedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Check for numbered list items (e.g., "1. ", "2. ", etc.)
                if (/^\d+\.\s/.test(line)) {
                    if (!inList) {
                        inList = true;
                        listType = 'ol';
                        processedLines.push('<ol>');
                    }
                    processedLines.push('<li>' + line.replace(/^\d+\.\s/, '') + '</li>');
                }
                // Check for bullet list items (e.g., "* " or "- ")
                else if (/^[\*\-]\s/.test(line)) {
                    if (!inList) {
                        inList = true;
                        listType = 'ul';
                        processedLines.push('<ul>');
                    }
                    processedLines.push('<li>' + line.replace(/^[\*\-]\s/, '') + '</li>');
                }
                // Not a list item
                else {
                    if (inList) {
                        inList = false;
                        processedLines.push('</' + listType + '>');
                    }
                    processedLines.push(line);
                }
            }
            
            // Close any open list at the end
            if (inList) {
                processedLines.push('</' + listType + '>');
            }
            
            let formattedContent = processedLines.join('\n');
            
            // Handle paragraphs (separated by double newlines)
            formattedContent = formattedContent.replace(/\n\s*\n/g, '</p><p>');
            
            // Handle single line breaks
            formattedContent = formattedContent.replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags if not already wrapped
            if (!formattedContent.includes('<p>') && !formattedContent.includes('<ul>') && !formattedContent.includes('<ol>')) {
                formattedContent = '<p>' + formattedContent + '</p>';
            }
            
            // Handle basic markdown-like formatting
            formattedContent = formattedContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')             // Italic
                .replace(/<(h[1-6])>(.*?)<\/\1>(<br>)?/g, '<$1>$2</$1>'); // Clean up headers
            
            return formattedContent;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;
            if (!state.apiKey) {
                alert('âš  Please set your OpenRouter API key in settings first');
                return;
            }

            const char = getCurrentCharacter();
            if (!char) return;

            input.value = '';
            input.style.height = 'auto';

            // Add user message
            char.messages.push({ role: 'user', content: message });
            renderChat();

            // Show typing indicator
            const messagesDiv = document.getElementById('messages');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message assistant';
            loadingEl.innerHTML = `<div class="message-bubble" style="border-color: ${char.color};"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
            messagesDiv.appendChild(loadingEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Multi-Personality Chat'
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [
                            { role: 'system', content: char.systemPrompt },
                            ...char.messages
                        ],
                        temperature: state.temperature,
                        max_tokens: state.maxTokens
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || 'API Error');
                }

                const assistantMessage = data.choices[0].message.content;
                char.messages.push({ role: 'assistant', content: assistantMessage });
                saveCharacters();
                renderChat();

            } catch (error) {
                console.error('Error:', error);
                alert(`âœ— Error: ${error.message}\n\nCheck your API key and internet connection.`);
                char.messages.pop();
                renderChat();
            }
        }

        // ============ UI HELPERS ============
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateApiStatus() {
            const status = document.getElementById('apiStatus');
            if (state.apiKey) {
                status.innerHTML = 'âœ“ API key configured (first 10 chars: ' + state.apiKey.substring(0, 10) + '...)';
                status.className = 'status-box success';
            } else {
                status.innerHTML = 'âœ— No API key set';
                status.className = 'status-box error';
            }
        }

        function updateSliderValues() {
            document.getElementById('tempValue').textContent = state.temperature.toFixed(1);
            document.getElementById('tokensValue').textContent = state.maxTokens;
        }

        // ============ MODAL MANAGEMENT ============
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('apiKeyInput').value = state.apiKey;
            renderManageCharsList();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function renderManageCharsList() {
            const list = document.getElementById('manageCharsList');
            list.innerHTML = state.characters.map(char => `
                <div class="manage-char-item">
                    <div class="manage-char-info">
                        <div class="manage-char-name">${char.name}</div>
                        <div class="manage-char-meta">
                            <span style="color: ${char.color};">â—</span>
                            ${char.messages.length} messages
                        </div>
                    </div>
                    <div class="manage-char-actions">
                        <button class="btn-secondary" style="flex: 0; padding: 6px 12px; font-size: 12px;" onclick="showCharacterInfo('${char.id}')">Edit</button>
                        <button class="btn-secondary" style="flex: 0; padding: 6px 12px; font-size: 12px;" onclick="clearCharacterHistory('${char.id}')" title="Clear Chat History">ðŸ§¹</button>
                        <button class="btn-danger" style="flex: 0; padding: 6px 12px; font-size: 12px;" onclick="deleteCharacter('${char.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // ============ EVENT LISTENERS ============
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('change', toggleTheme);

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', openSettings);
            document.getElementById('closeModalBtn').addEventListener('click', closeSettings);
            document.getElementById('closeCharInfoBtn').addEventListener('click', () => {
                document.getElementById('charInfoModal').classList.remove('active');
            });

            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            
            // Close sidebar when clicking outside
            document.addEventListener('click', closeSidebarOnClickOutside);

            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                    btn.classList.add('active');
                    document.querySelector(`.tab-content[data-tab="${btn.dataset.tab}"]`).style.display = 'block';
                });
            });

            // Model settings
            document.getElementById('modelSelect').addEventListener('change', (e) => {
                state.model = e.target.value;
                saveSettings();
            });

            document.getElementById('tempSlider').addEventListener('input', (e) => {
                state.temperature = parseFloat(e.target.value);
                updateSliderValues();
                saveSettings();
            });

            document.getElementById('tokensSlider').addEventListener('input', (e) => {
                state.maxTokens = parseInt(e.target.value);
                updateSliderValues();
                saveSettings();
            });

            // Character management
            document.getElementById('saveCharBtn').addEventListener('click', () => {
                const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                if (activeTab === 'api-settings') {
                    state.apiKey = document.getElementById('apiKeyInput').value.trim();
                    saveApiKey();
                    updateApiStatus();
                    alert('âœ“ API settings saved');
                } else if (activeTab === 'new-character') {
                    addNewCharacter();
                }
            });

            document.getElementById('saveEditCharBtn').addEventListener('click', saveCharacterEdit);
            
            // Clear history button in character info modal
            document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                if (state.editingCharId) {
                    clearCharacterHistory(state.editingCharId);
                }
            });

            // Chat
            const input = document.getElementById('messageInput');
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            });

            // Modal close on outside click
            document.getElementById('settingsModal').addEventListener('click', (e) => {
                if (e.target.id === 'settingsModal') closeSettings();
            });

            document.getElementById('charInfoModal').addEventListener('click', (e) => {
                if (e.target.id === 'charInfoModal') {
                    document.getElementById('charInfoModal').classList.remove('active');
                }
            });
            
            // Window resize handler
            window.addEventListener('resize', () => {
                const sidebar = document.querySelector('.sidebar');
                const toggleButton = document.getElementById('sidebarToggle');
                
                if (window.innerWidth > 768) {
                    // Desktop mode - always show sidebar
                    sidebar.classList.remove('collapsed', 'expanded');
                    toggleButton.style.display = 'none';
                } else {
                    // Mobile mode - hide sidebar by default
                    sidebar.classList.add('collapsed');
                    sidebar.classList.remove('expanded');
                    toggleButton.style.display = 'flex';
                }
            });
        }

        // Start the app
        init();
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>